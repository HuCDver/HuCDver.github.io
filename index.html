<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" integrity="sha512-fHwaWebuwA7NSF5Qg/af4UeDx9XqUpYpOGgubo3yWu+b2IQR4UeQwbb42Ti7gVAjNtVoI/I9TEoYeu9omwcC6g==" crossorigin="anonymous" referrerpolicy="no-referrer" /><!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/06/01/%E5%AE%89%E8%A3%85bcc%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/01/%E5%AE%89%E8%A3%85bcc%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">安装bcc和bpftrace踩坑记录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-06-01 10:00:00" itemprop="dateCreated datePublished" datetime="2024-06-01T10:00:00+08:00">2024-06-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-04-15 20:59:13" itemprop="dateModified" datetime="2025-04-15T20:59:13+08:00">2025-04-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blog/" itemprop="url" rel="index"><span itemprop="name">blog</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>环境：Linux xxx 6.5.0-26-generic #26~22.04.1-Ubuntu SMP PREEMPT_DYNAMIC  x86_64 x86_64 x86_64 GNU&#x2F;Linux</p>
<p>参考的安装教程：</p>
<p>​	bcc：<a target="_blank" rel="noopener" href="https://github.com/iovisor/bcc/blob/master/INSTALL.md">https://github.com/iovisor/bcc/blob/master/INSTALL.md</a></p>
<p>​	bpftrace：<a target="_blank" rel="noopener" href="https://github.com/bpftrace/bpftrace/blob/master/INSTALL.md">https://github.com/bpftrace/bpftrace/blob/master/INSTALL.md</a></p>
<ol>
<li><p>jammy版无法直接apt install</p>
<p>从源码Build</p>
<h2 id="Ubuntu-Source"><a href="#Ubuntu-Source" class="headerlink" title="Ubuntu - Source"></a>Ubuntu - Source</h2><p>To build the toolchain from source, one needs:</p>
<ul>
<li>LLVM 3.7.1 or newer, compiled with BPF support (default&#x3D;on)</li>
<li>Clang, built from the same tree as LLVM</li>
<li>cmake (&gt;&#x3D;3.1), gcc (&gt;&#x3D;4.7), flex, bison</li>
<li>LuaJIT, if you want Lua support</li>
<li>Optional tools used in some examples: arping, netperf, and iperf</li>
</ul>
<h3 id="Install-build-dependencies"><a href="#Install-build-dependencies" class="headerlink" title="Install build dependencies"></a>Install build dependencies</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># For Focal (20.04.1 LTS)</span><br><span class="line">sudo apt install -y zip bison build-essential cmake flex git libedit-dev \</span><br><span class="line">  libllvm12 llvm-12-dev libclang-12-dev python zlib1g-dev libelf-dev libfl-dev python3-setuptools \</span><br><span class="line">  liblzma-dev arping netperf iperf</span><br><span class="line"></span><br><span class="line"># For Hirsute (21.04) or Impish (21.10)</span><br><span class="line">sudo apt install -y zip bison build-essential cmake flex git libedit-dev \</span><br><span class="line">  libllvm12 llvm-12-dev libclang-12-dev python3 zlib1g-dev libelf-dev libfl-dev python3-setuptools \</span><br><span class="line">  liblzma-dev arping netperf iperf</span><br><span class="line"></span><br><span class="line"># For Jammy (22.04)</span><br><span class="line">sudo apt install -y zip bison build-essential cmake flex git libedit-dev \</span><br><span class="line">  libllvm14 llvm-14-dev libclang-14-dev python3 zlib1g-dev libelf-dev libfl-dev python3-setuptools \</span><br><span class="line">  liblzma-dev libdebuginfod-dev arping netperf iperf</span><br><span class="line">  </span><br><span class="line"># For Lunar Lobster (23.04)</span><br><span class="line">sudo apt install -y zip bison build-essential cmake flex git libedit-dev \</span><br><span class="line">  libllvm15 llvm-15-dev libclang-15-dev python3 zlib1g-dev libelf-dev libfl-dev python3-setuptools \</span><br><span class="line">  liblzma-dev libdebuginfod-dev arping netperf iperf libpolly-15-dev</span><br><span class="line"></span><br><span class="line"># For other versions</span><br><span class="line">sudo apt-get -y install zip bison build-essential cmake flex git libedit-dev \</span><br><span class="line">  libllvm3.7 llvm-3.7-dev libclang-3.7-dev python zlib1g-dev libelf-dev python3-setuptools \</span><br><span class="line">  liblzma-dev arping netperf iperf</span><br><span class="line"></span><br><span class="line"># For Lua support</span><br><span class="line">sudo apt-get -y install luajit luajit-5.1-dev</span><br></pre></td></tr></table></figure>

<h3 id="Install-and-compile-BCC"><a href="#Install-and-compile-BCC" class="headerlink" title="Install and compile BCC"></a>Install and compile BCC</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/iovisor/bcc.git</span><br><span class="line">mkdir bcc/build; cd bcc/build</span><br><span class="line">cmake ..</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line">cmake -DPYTHON_CMD=python3 .. # build python3 binding</span><br><span class="line">pushd src/python/</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line">popd</span><br></pre></td></tr></table></figure>
</li>
<li><p>cmake .. 指令报错：unable to find clang libraries</p>
<p>教程sudo apt install安装一堆依赖项时指定的clang版本与CMakeCache.txt中使用的版本不一致，在CMakeCache.txt查找clang-，找到相应版本修改sudo apt install安装依赖项的clang版本</p>
</li>
<li><p>运行sudo opensnoop-bpfcc报错：AttributeError: &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libbcc.so.0: undefined symbol: bpf_module_create_b</p>
<p>原因：<a target="_blank" rel="noopener" href="https://github.com/iovisor/bcc/issues/4583%EF%BC%8C%E8%80%81bcc">https://github.com/iovisor/bcc/issues/4583，老bcc</a> package的影响</p>
<p>解决方式：sudo rm -R &#x2F;usr&#x2F;lib&#x2F;python3&#x2F;dist-packages&#x2F;bcc</p>
</li>
<li><p>sudo apt install bpftrace后bpftrace报错：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">: CommandLine Error: Option <span class="string">&#x27;help-list&#x27;</span> registered more than once!</span><br><span class="line">LLVM ERROR: inconsistency <span class="keyword">in</span> registered CommandLine options</span><br></pre></td></tr></table></figure>

<p>原因及解决方式：Did you build bcc yourself, if you did make sure you dynamic link against llvm. See <a target="_blank" rel="noopener" href="https://github.com/bpftrace/bpftrace/commit/debc79ef9ad4784258705a92ae70f9c7689a9c24"><code>debc79e</code></a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> bcc/build</span><br><span class="line">cmake .. -DCMAKE_BUILD_TYPE=Debug -DCMAKE_INSTALL_PREFIX=/usr/local \</span><br><span class="line"> -DENABLE_EXAMPLES=0 -DENABLE_TESTS=0 -DENABLE_MAN=0 \</span><br><span class="line"> -DENABLE_LLVM_SHARED=1</span><br><span class="line">make &amp;&amp; <span class="built_in">sudo</span> make install &amp;&amp; <span class="built_in">sudo</span> ldconfig</span><br></pre></td></tr></table></figure>
</li>
<li><p>无论执行哪个命令bpftrace都报错：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> bpftrace -e <span class="string">&#x27;BEGIN &#123; print(&quot;test&quot;); &#125;&#x27;</span></span><br><span class="line">Attaching 1 probe...</span><br><span class="line">Segmentation fault</span><br></pre></td></tr></table></figure>

<p>原因：<a target="_blank" rel="noopener" href="https://github.com/bpftrace/bpftrace/issues/2420">https://github.com/bpftrace/bpftrace/issues/2420</a></p>
<p>IIUC, it’s Clang-specific. The problem has always been in bpftrace, just newer Clang&#x2F;LLVM (14+ I think) started to segfault on it. </p>
<p>解决方式：<a target="_blank" rel="noopener" href="https://github.com/larsks/netutils/commit/24625c5518859f7e4598e7642e1bfb2eb0403481">https://github.com/larsks/netutils/commit/24625c5518859f7e4598e7642e1bfb2eb0403481</a></p>
<p>Use bpftrace from trunk instead of release</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">We were hitting [1] in the release version of bpftrace. That problem was</span><br><span class="line">fixed in [2], and there hasn&#x27;t been a release since then. The project</span><br><span class="line">builds Docker images on every commit, so we can pull a recent build from</span><br><span class="line">the appropriate image tag.</span><br><span class="line"></span><br><span class="line">[1]: bpftrace/bpftrace#2420</span><br><span class="line">[2]: bpftrace/bpftrace@d470220</span><br></pre></td></tr></table></figure>


</li>
<li><p>直接git clone bpftrace，从源码build bpftrace，make报错</p>
<p>参考<a target="_blank" rel="noopener" href="https://github.com/bpftrace/bpftrace/blob/master/docker/Dockerfile.ubuntu">https://github.com/bpftrace/bpftrace/blob/master/docker/Dockerfile.ubuntu</a></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:devel</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> DEBIAN_FRONTEND=noninteractive</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y \</span></span><br><span class="line"><span class="language-bash">    asciidoctor \</span></span><br><span class="line"><span class="language-bash">    binutils-dev \</span></span><br><span class="line"><span class="language-bash">    bison \</span></span><br><span class="line"><span class="language-bash">    build-essential \</span></span><br><span class="line"><span class="language-bash">    clang \</span></span><br><span class="line"><span class="language-bash">    cmake \</span></span><br><span class="line"><span class="language-bash">    flex \</span></span><br><span class="line"><span class="language-bash">    libbpf-dev \</span></span><br><span class="line"><span class="language-bash">    libbpfcc-dev \</span></span><br><span class="line"><span class="language-bash">    libcereal-dev \</span></span><br><span class="line"><span class="language-bash">    libelf-dev \</span></span><br><span class="line"><span class="language-bash">    libiberty-dev \</span></span><br><span class="line"><span class="language-bash">    libpcap-dev \</span></span><br><span class="line"><span class="language-bash">    llvm-dev \</span></span><br><span class="line"><span class="language-bash">    liblldb-dev \</span></span><br><span class="line"><span class="language-bash">    libclang-dev \</span></span><br><span class="line"><span class="language-bash">    systemtap-sdt-dev \</span></span><br><span class="line"><span class="language-bash">    zlib1g-dev</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . /src</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /src</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> cmake -B /build -DBUILD_TESTING=OFF</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> make -C /build -j$(<span class="built_in">nproc</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/build/src/bpftrace&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<p>cmake成功：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~/bpftrace$ cmake -B ./build -DBUILD_TESTING=OFF</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">-- Configuring <span class="keyword">done</span></span><br><span class="line">-- Generating <span class="keyword">done</span></span><br><span class="line">-- Build files have been written to: /home/xxx/bpftrace/build</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>make报错：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">~/bpftrace$ make -C ./build -j$(<span class="built_in">nproc</span>)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">/home/xxx/bpftrace/src/attached_probe.cpp: In member <span class="keyword">function</span> ‘void bpftrace::AttachedProbe::load_prog(bpftrace::BPFfeature&amp;)’:</span><br><span class="line">/home/xxx/bpftrace/src/attached_probe.cpp:760:37: error: expected primary-expression before ‘,’ token</span><br><span class="line">  760 |       LIBBPF_OPTS(bpf_prog_load_opts, opts);</span><br><span class="line">      |                                     ^</span><br><span class="line">/home/xxx/bpftrace/src/attached_probe.cpp:760:39: error: ‘opts’ was not declared <span class="keyword">in</span> this scope</span><br><span class="line">  760 |       LIBBPF_OPTS(bpf_prog_load_opts, opts);</span><br><span class="line">      |                                       ^~~~</span><br><span class="line">/home/xxx/bpftrace/src/attached_probe.cpp:760:7: error: ‘LIBBPF_OPTS’ was not declared <span class="keyword">in</span> this scope; did you mean ‘LIBBPF_API’?</span><br><span class="line">  760 |       LIBBPF_OPTS(bpf_prog_load_opts, opts);</span><br><span class="line">      |       ^~~~~~~~~~~</span><br><span class="line">      |       LIBBPF_API</span><br><span class="line">/home/xxx/bpftrace/src/attached_probe.cpp:823:21: error: ‘bpf_btf_load_opts’ was not declared <span class="keyword">in</span> this scope; did you mean ‘bpf_prog_load_opts’?</span><br><span class="line">  823 |         LIBBPF_OPTS(bpf_btf_load_opts,</span><br><span class="line">      |                     ^~~~~~~~~~~~~~~~~</span><br><span class="line">      |                     bpf_prog_load_opts</span><br><span class="line">/home/xxx/bpftrace/src/attached_probe.cpp:824:21: error: ‘btf_opts’ was not declared <span class="keyword">in</span> this scope; did you mean ‘btf_ptr’?</span><br><span class="line">  824 |                     btf_opts,</span><br><span class="line">      |                     ^~~~~~~~</span><br><span class="line">      |                     btf_ptr</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">make[2]: *** [src/CMakeFiles/runtime.dir/build.make:76: src/CMakeFiles/runtime.dir/attached_probe.cpp.o] Error 1</span><br><span class="line">make[1]: *** [CMakeFiles/Makefile2:475: src/CMakeFiles/runtime.dir/all] Error 2</span><br><span class="line">make[1]: *** Waiting <span class="keyword">for</span> unfinished <span class="built_in">jobs</span>....</span><br><span class="line">[ 52%] Linking CXX static library libaot.a</span><br><span class="line">[ 52%] Built target aot</span><br><span class="line">make: *** [Makefile:136: all] Error 2</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>疑似类似问题：<a target="_blank" rel="noopener" href="https://github.com/bpftrace/bpftrace/issues/2409">https://github.com/bpftrace/bpftrace/issues/2409</a></p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/04/25/%E8%AE%AD%E7%BB%83%E7%BB%8F%E9%AA%8C%E6%91%98%E5%BD%95%20996efa07914a43b68886a10868d83e1d/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/04/25/%E8%AE%AD%E7%BB%83%E7%BB%8F%E9%AA%8C%E6%91%98%E5%BD%95%20996efa07914a43b68886a10868d83e1d/" class="post-title-link" itemprop="url">训练经验摘录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-04-25 10:00:00" itemprop="dateCreated datePublished" datetime="2024-04-25T10:00:00+08:00">2024-04-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-04-15 22:28:43" itemprop="dateModified" datetime="2025-04-15T22:28:43+08:00">2025-04-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blog/" itemprop="url" rel="index"><span itemprop="name">blog</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li><p><strong>Training language models to follow instructions with human feedback</strong></p>
<ul>
<li>Supervised Fine-Tuning: 16epoch, a cosine lr decay, residual dropout 0.2</li>
<li>训练多个模型，最后根据验证集上的分数选择最终模型</li>
<li>是否过拟合并非唯一评价标准，观察更多epoch的得分情况</li>
<li>过拟合的原因：数据点之间相关度过高</li>
<li>per-token 的 KL 惩罚降低奖励模型的过优化</li>
<li>PPO-ptx</li>
</ul>
</li>
<li><p><strong>What matters when building vision-language models?</strong></p>
<ul>
<li>如果一个模型参数量更大但表现与参数量较小的模型相近，则参数量较大的模型<strong>训练不充分</strong></li>
<li>可以观察<strong>冻结部分模型后可训练的参数量</strong>，及其与整体参数量的比例，较低比例可能限制训练的表达能力</li>
<li><strong>loss divergence</strong>可能由：学习率过高、梯度爆炸、模型过拟合而学习数据中的噪声、数据质量差、模型架构问题等因素导致，解决措施有：降低学习率（甚至可以激进地降低）、逐步解冻多种组件而非直接完全解冻、用LoRa调整预训练的参数并使用标准的全参数微调来更新新初始化的参数、梯度剪切、调整模型架构（如使用更稳定的激活函数或初始化方法）、引入正则化、提高数据质量等</li>
<li>用<strong>Transformer-based pooling</strong>（perceiver resampler）作池化<strong>降低视觉token数</strong>，既能提高性能又减少了视觉token数，传统的池化会降低性能</li>
<li>interpolate在低分辨率下训练的<strong>位置编码</strong>可以适应高分辨率图片，需要用LoRa调vision encoder以适应这些调整</li>
<li>用计算量换取性能提升：在指令微调阶段将输入由一张图像转换为五张图像的list：四张<strong>crops</strong>和一张原始图像，可以在对<strong>图像分辨率要求较高的任务</strong>中提高性能</li>
<li><strong>将训练划分为多个阶段</strong>，每个阶段设置不同的最大分辨率和序列长度以适应不同的训练数据</li>
<li>用<strong>梯度累积</strong>减少GPU内存开销</li>
<li>降低<strong>过拟合的风险</strong>：用NEFTune技术向embeds添加噪声，随机缩放训练中的图像分辨率， shuffle the multiple user&#x2F;assistant turns randomly before feeding the example to the model</li>
</ul>
</li>
<li><p>Stabilize training and enhance Transformer  model performence</p>
<ul>
<li>Sub-LayerNorm 的表现比 Pre-LayerNorm 更好</li>
<li>在 FFN 中使用 GeGLU 作为activation function</li>
<li>引入 relative position bias，在预训练阶段不同自注意层共享该参数，在微调阶段各层解耦</li>
<li>引入 LayerScale 动态调整每个残差块的输出，即在1+x运算之前，给x乘一个可学习的对角矩阵，初始化为 1e-6</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/03/23/ViTPose%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/03/23/ViTPose%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">ViTPose笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-03-23 10:00:00" itemprop="dateCreated datePublished" datetime="2024-03-23T10:00:00+08:00">2024-03-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-04-15 22:15:56" itemprop="dateModified" datetime="2025-04-15T22:15:56+08:00">2025-04-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blog/" itemprop="url" rel="index"><span itemprop="name">blog</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="OBSERVATION"><a href="#OBSERVATION" class="headerlink" title="OBSERVATION"></a>OBSERVATION</h1><h2 id="KNOWLEDGE"><a href="#KNOWLEDGE" class="headerlink" title="KNOWLEDGE"></a>KNOWLEDGE</h2><p>目前Transformer被如何用于人体姿态估计：</p>
<ol>
<li>用于改善backbone提取的特征并建模关键点之间的关系：PRTR使用Transformer的encoder和decoder以瀑布流的形式逐渐改善关键点位置；TokenPose和TransPose仅用Transformer的encoder处理backbone提取的特征；</li>
<li>用于backbone提取特征：HRFormer使用Transformer直接提取特征，通过多分辨率并行Transformer模组提供高分辨率表征；</li>
</ol>
<p>目前Transforner应用的缺陷：</p>
<ol>
<li>需要额外的卷积网络作为backbone提取特征</li>
<li>需要对Transformer模块进行精细设计以适应人体姿态估计任务</li>
</ol>
<p>该框架的解决方法：</p>
<ol>
<li>使用非分层的视觉transformer作为backbone，初始化用掩码图像建模预文本任务进行预训练</li>
<li>使用轻量化的decoder上采样提取的特征图并预测热力图，由两个反卷积层和一个预测层组成</li>
</ol>
<p><img src="/2024/03/23/ViTPose%E7%AC%94%E8%AE%B0/framework.png" alt="framework"></p>
<h2 id="IDEA"><a href="#IDEA" class="headerlink" title="IDEA"></a>IDEA</h2><p><em>how well can the plain vision transformer do for pose estimation?</em></p>
<h2 id="DATAFLOW"><a href="#DATAFLOW" class="headerlink" title="DATAFLOW"></a>DATAFLOW</h2><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>X</mi><mo>∈</mo><msup><mi mathvariant="normal">ℜ</mi><mrow><mi>H</mi><mo>×</mo><mi>W</mi><mo>×</mo><mn>3</mn></mrow></msup><mspace linebreak="newline"></mspace><mo>−</mo><mo>→</mo><mo>−</mo><mspace linebreak="newline"></mspace><msub><mi>F</mi><mn>0</mn></msub><mo>=</mo><mi>P</mi><mi>a</mi><mi>t</mi><mi>c</mi><mi>h</mi><mi>E</mi><mi>m</mi><mi>b</mi><mi>e</mi><mi>d</mi><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><msub><mi>F</mi><mn>0</mn></msub><mo>∈</mo><msup><mi mathvariant="normal">ℜ</mi><mrow><mfrac><mi>H</mi><mi>d</mi></mfrac><mo>×</mo><mfrac><mi>W</mi><mi>d</mi></mfrac><mo>×</mo><mi>C</mi></mrow></msup><mspace linebreak="newline"></mspace><mo>−</mo><mo>→</mo><mo>−</mo><mspace linebreak="newline"></mspace><msubsup><mi>F</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo>=</mo><msub><mi>F</mi><mi>i</mi></msub><mo>+</mo><mi>M</mi><mi>H</mi><mi>S</mi><mi>A</mi><mo stretchy="false">(</mo><mi>L</mi><mi>N</mi><mo stretchy="false">(</mo><msub><mi>F</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><msub><mi>F</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>=</mo><msubsup><mi>F</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo>+</mo><mi>F</mi><mi>F</mi><mi>N</mi><mo stretchy="false">(</mo><mi>L</mi><mi>N</mi><mo stretchy="false">(</mo><msubsup><mi>F</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><msub><mi>F</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo>∈</mo><msup><mi mathvariant="normal">ℜ</mi><mrow><mfrac><mi>H</mi><mi>d</mi></mfrac><mo>×</mo><mfrac><mi>W</mi><mi>d</mi></mfrac><mo>×</mo><mi>C</mi></mrow></msup><mspace linebreak="newline"></mspace><mo>−</mo><mo>→</mo><mo>−</mo><mspace linebreak="newline"></mspace><mi>K</mi><mo>=</mo><mi>C</mi><mi>o</mi><mi>n</mi><msub><mi>v</mi><mrow><mn>1</mn><mo>×</mo><mn>1</mn></mrow></msub><mo stretchy="false">(</mo><mi>D</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>v</mi><mo stretchy="false">(</mo><mi>D</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>v</mi><mo stretchy="false">(</mo><msub><mi>F</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mi>K</mi><mo>∈</mo><msup><mi mathvariant="normal">ℜ</mi><mrow><mfrac><mi>H</mi><mn>4</mn></mfrac><mo>×</mo><mfrac><mi>W</mi><mn>4</mn></mfrac><mo>×</mo><msub><mi>N</mi><mi>k</mi></msub></mrow></msup><mspace linebreak="newline"></mspace><mo>=</mo><mi mathvariant="normal">∣</mi><mo>=</mo><mspace linebreak="newline"></mspace><mi>K</mi><mo>=</mo><mi>C</mi><mi>o</mi><mi>n</mi><msub><mi>v</mi><mrow><mn>3</mn><mo>×</mo><mn>3</mn></mrow></msub><mo stretchy="false">(</mo><mi>B</mi><mi>i</mi><mi>l</mi><mi>i</mi><mi>n</mi><mi>e</mi><mi>a</mi><mi>r</mi><mo stretchy="false">(</mo><mi>R</mi><mi>e</mi><mi>L</mi><mi>U</mi><mo stretchy="false">(</mo><msub><mi>F</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mi>K</mi><mo>∈</mo><msup><mi mathvariant="normal">ℜ</mi><mrow><mfrac><mi>H</mi><mn>4</mn></mfrac><mo>×</mo><mfrac><mi>W</mi><mn>4</mn></mfrac><mo>×</mo><msub><mi>N</mi><mi>k</mi></msub></mrow></msup><mspace linebreak="newline"></mspace><mo>=</mo><mi mathvariant="normal">∣</mi><mo>=</mo><mspace linebreak="newline"></mspace><msup><mi>K</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mi>C</mi><mi>o</mi><mi>n</mi><msub><mi>v</mi><mrow><mn>1</mn><mo>×</mo><mn>1</mn></mrow></msub><mo stretchy="false">(</mo><msub><mi>F</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo stretchy="false">)</mo><mo separator="true">,</mo><mspace linebreak="newline"></mspace><msup><mi>K</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>∈</mo><msup><mi mathvariant="normal">ℜ</mi><mrow><mfrac><mi>H</mi><mn>16</mn></mfrac><mo>×</mo><mfrac><mi>W</mi><mn>16</mn></mfrac><mo>×</mo><mo stretchy="false">(</mo><mn>16</mn><msub><mi>N</mi><mi>k</mi></msub><mo stretchy="false">)</mo></mrow></msup><mspace linebreak="newline"></mspace><mi>K</mi><mo>=</mo><mi>P</mi><mi>i</mi><mi>x</mi><mi>e</mi><mi>l</mi><mi>U</mi><mi>n</mi><mi>s</mi><mi>h</mi><mi>u</mi><mi>f</mi><mi>f</mi><mi>l</mi><mi>e</mi><mo stretchy="false">(</mo><msup><mi>K</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">)</mo><mspace linebreak="newline"></mspace><mi>K</mi><mo>∈</mo><msup><mi mathvariant="normal">ℜ</mi><mrow><mfrac><mi>H</mi><mn>4</mn></mfrac><mo>×</mo><mfrac><mi>W</mi><mn>4</mn></mfrac><mo>×</mo><msub><mi>N</mi><mi>k</mi></msub></mrow></msup><mspace linebreak="newline"></mspace><mo>=</mo><mi mathvariant="normal">∣</mi><mo>=</mo><mspace linebreak="newline"></mspace><mi>K</mi><mo>=</mo><mi>A</mi><mi>E</mi><mo stretchy="false">(</mo><mi>D</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>v</mi><mo stretchy="false">(</mo><msub><mi>F</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
X\in \real ^{H\times W\times3}\\
-\to-\\
F_0=PatchEmbed(X)\\
F_0\in \real ^{\frac{H}{d}\times \frac{W}{d}\times C}\\
-\to-\\
F&#x27;_{i+1}=F_i+MHSA(LN(F_i)),\\
F_{i+1}=F&#x27;_{i+1}+FFN(LN(F&#x27;_{i+1})),\\
F_{out}\in \real ^{\frac{H}{d}\times \frac{W}{d}\times C}\\
-\to-\\
K=Conv_{1\times 1}(Deconv(Deconv(F_{out})))\\
K\in \real ^{\frac{H}{4}\times \frac{W}{4}\times N_k}\\
=|=\\
K=Conv_{3\times 3}(Bilinear(ReLU(F_{out})))\\
K\in \real ^{\frac{H}{4}\times \frac{W}{4}\times N_k}\\
=|=\\
K&#x27;=Conv_{1\times 1}(F_{out}),\\
K&#x27;\in \real ^{\frac{H}{16}\times \frac{W}{16}\times (16N_k)}\\
K=PixelUnshuffle(K&#x27;)\\
K\in \real ^{\frac{H}{4}\times \frac{W}{4}\times N_k}\\
=|=\\
K=AE(Deconv(F_{out}))
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8913em;"></span><span class="mord"><span class="mord">ℜ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span><span class="mbin mtight">×</span><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">−</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">−</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">c</span><span class="mord mathnormal">h</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mord mathnormal">mb</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0235em;"></span><span class="mord"><span class="mord">ℜ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0235em;"><span style="top:-3.413em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8721em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8721em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span></span></span></span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">−</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">−</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1.1072em;vertical-align:-0.3053em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3053em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">A</span><span class="mopen">(</span><span class="mord mathnormal">L</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">))</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1072em;vertical-align:-0.3053em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3053em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1072em;vertical-align:-0.3053em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">FFN</span><span class="mopen">(</span><span class="mord mathnormal">L</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3053em;"><span></span></span></span></span></span></span><span class="mclose">))</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0235em;"></span><span class="mord"><span class="mord">ℜ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0235em;"><span style="top:-3.413em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8721em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8721em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">×</span><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span></span></span></span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">−</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord">−</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">×</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">Deco</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mopen">(</span><span class="mord mathnormal">Deco</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)))</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0235em;"></span><span class="mord"><span class="mord">ℜ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0235em;"><span style="top:-3.413em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8721em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8721em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.109em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mbin mtight">×</span><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">in</span><span class="mord mathnormal">e</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.10903em;">LU</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)))</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0235em;"></span><span class="mord"><span class="mord">ℜ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0235em;"><span style="top:-3.413em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8721em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8721em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.109em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.8019em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">×</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.841em;vertical-align:-0.0391em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0235em;"></span><span class="mord"><span class="mord">ℜ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0235em;"><span style="top:-3.413em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8721em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">16</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8721em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">16</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">×</span><span class="mopen mtight">(</span><span class="mord mtight">16</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.109em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0519em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">i</span><span class="mord mathnormal">x</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal">n</span><span class="mord mathnormal">s</span><span class="mord mathnormal">h</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.10764em;">ff</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0235em;"></span><span class="mord"><span class="mord">ℜ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0235em;"><span style="top:-3.413em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8721em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8721em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.109em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.3669em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mopen">(</span><span class="mord mathnormal">Deco</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">))</span></span></span></span></span>



<h1 id="REF"><a href="#REF" class="headerlink" title="REF"></a>REF</h1><ol>
<li><a target="_blank" rel="noopener" href="https://arxiv.org/abs/2104.02057">An empirical study of training self-supervised vision transformers</a></li>
<li><a target="_blank" rel="noopener" href="https://www.ecva.net/papers/eccv_2022/papers_ECCV/papers/136930468.pdf">RegionCL: Exploring Contrastive Region Pairs for Self-supervised Representation Learning</a></li>
<li><a target="_blank" rel="noopener" href="https://arxiv.org/abs/2106.08254">BEiT: BERT Pre-Training of Image Transformers</a></li>
<li><a target="_blank" rel="noopener" href="https://arxiv.org/abs/2111.06377">Masked Autoencoders Are Scalable Vision Learners</a></li>
<li><a target="_blank" rel="noopener" href="https://arxiv.org/abs/1611.05424">Associative Embedding: End-to-End Learning for Joint Detection and Grouping</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/01/28/Writeup-RealWorldCTF2024-The-truth-of-Plain/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/01/28/Writeup-RealWorldCTF2024-The-truth-of-Plain/" class="post-title-link" itemprop="url">Writeup-RealWorldCTF2024-The-truth-of-Plain</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-01-28 10:00:00" itemprop="dateCreated datePublished" datetime="2024-01-28T10:00:00+08:00">2024-01-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-04-15 21:38:25" itemprop="dateModified" datetime="2025-04-15T21:38:25+08:00">2025-04-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blog/" itemprop="url" rel="index"><span itemprop="name">blog</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><p>The truth of Plain<br>Score: 176<br>Misc, Crypto, difficulty:Baby</p>
<p>You are right, but “CTF” originated from the DEFCON global hacker conference in 1996. It is a competitive game among network security enthusiasts. This game takes place in a competition called “RealWorld”, where those who solve the challenge will be awarded a “Flag”. You will play a character named “CTFer” and work with your teammates in the game, using knowledge and skills to solve various challenges - and at the same time, gradually discover the truth of “Plain”.</p>
<p>Repository: <a target="_blank" rel="noopener" href="https://github.com/gwuhaolin/lightsocks">https://github.com/gwuhaolin/lightsocks</a></p>
<h2 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h2><ol>
<li><p>打开repo链接熟悉协议，得知ss连接建立和加解密的信息</p>
</li>
<li><p>打开并解压zip文件，要求密码，于是认为该密码需要经pcap分析得到</p>
</li>
<li><p>Wireshark分析pcap文件，关注到几个Data长度不为0的tcp包，这些包Data长度依次为3，2，10，7，一百多，两千多，3，2，10，7，一百多，两千多</p>
<p><img src="/2024/01/28/Writeup-RealWorldCTF2024-The-truth-of-Plain/tcp_regular.png" alt="tcp_regular"></p>
</li>
<li><p>结合协议发现3，2，10，7的包为建立加密连接过程，一百多和两千多的包分别为加密的请求和响应，因此该pcap可分为两次连接</p>
</li>
<li><p>由协议知明文和密文为一一对应关系，对照协议中连接建立的字段和建立加密连接过程的包，得到部分加密box</p>
<p><img src="/2024/01/28/Writeup-RealWorldCTF2024-The-truth-of-Plain/ss_3.png" alt="ss_3"></p>
<p>参考<a target="_blank" rel="noopener" href="https://github.com/gwuhaolin/blog/issues/12">https://github.com/gwuhaolin/blog/issues/12</a></p>
<table>
<thead>
<tr>
<th>VER</th>
<th>NMETHODS</th>
<th>METHODS</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
</tbody></table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">box=&#123;<span class="number">0x00</span>:<span class="number">0x78</span>,<span class="number">0x01</span>:<span class="number">0x99</span>,<span class="number">0x03</span>:<span class="number">0xfd</span>,<span class="number">0x05</span>:<span class="number">0xf3</span>&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>搜索相似题目，根据请求和响应的包大小猜测传输的是HTTP报文，先猜GET方法</p>
<p><img src="/2024/01/28/Writeup-RealWorldCTF2024-The-truth-of-Plain/guess_http.png"></p>
</li>
<li><p>若0x89 0x62 0x6e分别为box[‘G’] box[‘E’] box[‘T’]，下文不远处找到0x2f 0x6e 0x6e 0x92，即? box[‘T’] box[‘T’] ?，符合box[‘H’] box[‘T’] box[‘T’] box[‘P’]模式，说明猜测可能正确</p>
</li>
<li><p>同理，根据HTTP格式和常用字符猜测其他对应关系，可以确定为HTTP报文。猜测拓展已知加密box，据此得到解密box还原部分报文，迭代该过程，得到部分加密box（box）及解密box（rev_box）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">box=&#123;</span><br><span class="line"><span class="number">0x00</span>:<span class="number">0x78</span>,<span class="number">0x01</span>:<span class="number">0x99</span>,<span class="number">0x03</span>:<span class="number">0xfd</span>,<span class="number">0x05</span>:<span class="number">0xf3</span>,<span class="comment">##ss5</span></span><br><span class="line"><span class="number">0x47</span>:<span class="number">0x89</span>,<span class="number">0x45</span>:<span class="number">0x62</span>,<span class="number">0x54</span>:<span class="number">0x6e</span>,<span class="comment">##GET</span></span><br><span class="line"><span class="number">0x20</span>:<span class="number">0x30</span>,<span class="comment">##&lt;SPACE&gt;</span></span><br><span class="line"><span class="number">0x2f</span>:<span class="number">0xc1</span>,<span class="comment">##/</span></span><br><span class="line"><span class="number">0x48</span>:<span class="number">0x2f</span>,<span class="number">0x50</span>:<span class="number">0x92</span>,<span class="number">0x31</span>:<span class="number">0xb0</span>,<span class="number">0x2e</span>:<span class="number">0x14</span>,<span class="comment">##HP1.</span></span><br><span class="line"><span class="number">0x32</span>:<span class="number">0xdc</span>,<span class="number">0x30</span>:<span class="number">0x61</span>,<span class="comment">##200</span></span><br><span class="line"><span class="number">0x0a</span>:<span class="number">0x56</span>,<span class="number">0x0d</span>:<span class="number">0xca</span>,<span class="comment">##\r\n</span></span><br><span class="line"><span class="number">0x6f</span>:<span class="number">0x0a</span>,<span class="number">0x73</span>:<span class="number">0x45</span>,<span class="number">0x74</span>:<span class="number">0x02</span>,<span class="number">0x3a</span>:<span class="number">0xcb</span>,<span class="comment">##ost:</span></span><br><span class="line"><span class="number">0x4f</span>:<span class="number">0x54</span>,<span class="number">0x4b</span>:<span class="number">0x9d</span>,<span class="comment">##OK</span></span><br><span class="line"><span class="number">0x55</span>:<span class="number">0x00</span>,<span class="number">0x73</span>:<span class="number">0x45</span>,<span class="number">0x65</span>:<span class="number">0x1c</span>,<span class="number">0x72</span>:<span class="number">0xc7</span>,<span class="number">0x2d</span>:<span class="number">0x35</span>,<span class="number">0x41</span>:<span class="number">0xbf</span>,<span class="number">0x67</span>:<span class="number">0xab</span>,<span class="number">0x65</span>:<span class="number">0x1c</span>,<span class="number">0x6e</span>:<span class="number">0xee</span>,<span class="number">0x74</span>:<span class="number">0x02</span>,<span class="comment">##User-Agent</span></span><br><span class="line"><span class="number">0x57</span>:<span class="number">0x88</span>,<span class="comment">#Wget</span></span><br><span class="line"><span class="number">0x41</span>:<span class="number">0xbf</span>,<span class="number">0x63</span>:<span class="number">0xfb</span>,<span class="number">0x63</span>:<span class="number">0xfb</span>,<span class="number">0x65</span>:<span class="number">0x1c</span>,<span class="number">0x70</span>:<span class="number">0x01</span>,<span class="number">0x74</span>:<span class="number">0x02</span>,<span class="comment">#Accept</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rev_box = <span class="built_in">dict</span>(<span class="built_in">zip</span>(box.values(),box.keys()))</span><br></pre></td></tr></table></figure>
</li>
<li><p>进一步结合附件中的文件名、HTTP时间戳与pcap中的包时间戳、第二次响应的大量文本、连接地址、python版本等得到box</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">box=&#123;</span><br><span class="line"><span class="number">0x00</span>:<span class="number">0x78</span>,<span class="number">0x01</span>:<span class="number">0x99</span>,<span class="number">0x03</span>:<span class="number">0xfd</span>,<span class="number">0x05</span>:<span class="number">0xf3</span>,<span class="comment">##ss5</span></span><br><span class="line"><span class="number">0x47</span>:<span class="number">0x89</span>,<span class="number">0x45</span>:<span class="number">0x62</span>,<span class="number">0x54</span>:<span class="number">0x6e</span>,<span class="comment">##GET</span></span><br><span class="line"><span class="number">0x20</span>:<span class="number">0x30</span>,<span class="comment">##&lt;SPACE&gt;</span></span><br><span class="line"><span class="number">0x2f</span>:<span class="number">0xc1</span>,<span class="comment">##/</span></span><br><span class="line"><span class="number">0x48</span>:<span class="number">0x2f</span>,<span class="number">0x50</span>:<span class="number">0x92</span>,<span class="number">0x31</span>:<span class="number">0xb0</span>,<span class="number">0x2e</span>:<span class="number">0x14</span>,<span class="comment">##HP1.</span></span><br><span class="line"><span class="number">0x32</span>:<span class="number">0xdc</span>,<span class="number">0x30</span>:<span class="number">0x61</span>,<span class="comment">##200</span></span><br><span class="line"><span class="number">0x0a</span>:<span class="number">0x56</span>,<span class="number">0x0d</span>:<span class="number">0xca</span>,<span class="comment">##\r\n</span></span><br><span class="line"><span class="number">0x6f</span>:<span class="number">0x0a</span>,<span class="number">0x73</span>:<span class="number">0x45</span>,<span class="number">0x74</span>:<span class="number">0x02</span>,<span class="number">0x3a</span>:<span class="number">0xcb</span>,<span class="comment">##ost:</span></span><br><span class="line"><span class="number">0x4f</span>:<span class="number">0x54</span>,<span class="number">0x4b</span>:<span class="number">0x9d</span>,<span class="comment">##OK</span></span><br><span class="line"><span class="number">0x55</span>:<span class="number">0x00</span>,<span class="number">0x73</span>:<span class="number">0x45</span>,<span class="number">0x65</span>:<span class="number">0x1c</span>,<span class="number">0x72</span>:<span class="number">0xc7</span>,<span class="number">0x2d</span>:<span class="number">0x35</span>,<span class="number">0x41</span>:<span class="number">0xbf</span>,<span class="number">0x67</span>:<span class="number">0xab</span>,<span class="number">0x65</span>:<span class="number">0x1c</span>,<span class="number">0x6e</span>:<span class="number">0xee</span>,<span class="number">0x74</span>:<span class="number">0x02</span>,<span class="comment">##User-Agent</span></span><br><span class="line"><span class="number">0x57</span>:<span class="number">0x88</span>,<span class="comment">#Wget</span></span><br><span class="line"><span class="number">0x41</span>:<span class="number">0xbf</span>,<span class="number">0x63</span>:<span class="number">0xfb</span>,<span class="number">0x63</span>:<span class="number">0xfb</span>,<span class="number">0x65</span>:<span class="number">0x1c</span>,<span class="number">0x70</span>:<span class="number">0x01</span>,<span class="number">0x74</span>:<span class="number">0x02</span>,<span class="comment">#Accept</span></span><br><span class="line"><span class="number">0x53</span>:<span class="number">0x2d</span>,<span class="number">0x65</span>:<span class="number">0x1c</span>,<span class="number">0x63</span>:<span class="number">0xfb</span>,<span class="number">0x72</span>:<span class="number">0xc7</span>,<span class="number">0x65</span>:<span class="number">0x1c</span>,<span class="number">0x74</span>:<span class="number">0x02</span>,<span class="number">0x2e</span>:<span class="number">0x14</span>,<span class="number">0x7a</span>:<span class="number">0x3f</span>,<span class="number">0x69</span>:<span class="number">0xeb</span>,<span class="number">0x70</span>:<span class="number">0x01</span>,<span class="comment">##Secret.zip</span></span><br><span class="line"><span class="number">0x64</span>:<span class="number">0xf4</span>,<span class="number">0x6c</span>:<span class="number">0x5c</span>,<span class="number">0x76</span>:<span class="number">0x0e</span>,<span class="number">0x43</span>:<span class="number">0x2e</span>,<span class="number">0x2a</span>:<span class="number">0xc4</span>,<span class="number">0x6d</span>:<span class="number">0xf1</span>,<span class="number">0x79</span>:<span class="number">0x85</span>,<span class="number">0x68</span>:<span class="number">0x27</span>,<span class="number">0x61</span>:<span class="number">0xc9</span>,<span class="number">0x4c</span>:<span class="number">0xe0</span>,<span class="number">0x4d</span>:<span class="number">0x4b</span>,<span class="number">0x66</span>:<span class="number">0x48</span>,<span class="comment">##dlvC*myhaLMf</span></span><br><span class="line"><span class="number">0x4a</span>:<span class="number">0x58</span>,<span class="number">0x44</span>:<span class="number">0xf5</span>,<span class="number">0x75</span>:<span class="number">0x53</span>,<span class="number">0x77</span>:<span class="number">0xdb</span>,<span class="number">0x6a</span>:<span class="number">0x86</span>,<span class="number">0x49</span>:<span class="number">0x5a</span>,<span class="number">0x6b</span>:<span class="number">0x8d</span>,<span class="number">0x62</span>:<span class="number">0xb2</span>,<span class="number">0x71</span>:<span class="number">0xcf</span>,<span class="number">0x46</span>:<span class="number">0xd5</span>,<span class="number">0x27</span>:<span class="number">0x1d</span>,<span class="number">0x2c</span>:<span class="number">0x13</span>,<span class="comment">#JDuwjIkbqF&#x27;,</span></span><br><span class="line"><span class="number">0x34</span>:<span class="number">0x40</span>,<span class="number">0x38</span>:<span class="number">0x49</span>,<span class="number">0x33</span>:<span class="number">0x1a</span>,<span class="number">0x37</span>:<span class="number">0x3e</span>,<span class="number">0x36</span>:<span class="number">0x12</span>,<span class="number">0x39</span>:<span class="number">0xa5</span>,<span class="number">0x35</span>:<span class="number">0x23</span>,<span class="number">0x22</span>:<span class="number">0x67</span>,<span class="number">0x52</span>:<span class="number">0xce</span>,<span class="comment">#4837695&quot;R</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rev_box = <span class="built_in">dict</span>(<span class="built_in">zip</span>(box.values(),box.keys()))</span><br></pre></td></tr></table></figure>
</li>
<li><p>则两次HTTP请求、第一次响应的HTTP头及部分数据、第二次HTTP响应已可完全解密</p>
<p>client_1:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/Secret.zip</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"></span><br><span class="line"><span class="language-http"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.5.72:8000</span></span><br><span class="line"><span class="language-http"></span></span><br><span class="line"><span class="language-http"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Wget/1.21.2</span></span><br><span class="line"><span class="language-http"></span></span><br><span class="line"><span class="language-http"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span></span><br><span class="line"><span class="language-http"></span></span><br><span class="line"><span class="language-http"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>identity</span></span><br><span class="line"><span class="language-http"></span></span><br><span class="line"><span class="language-http"><span class="attribute">Connection</span><span class="punctuation">: </span>Keep-Alive</span></span><br></pre></td></tr></table></figure>

<p>server_1_partial:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.0</span> <span class="number">200</span> OK</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">Server</span>: SimpleHTTP/<span class="number">0</span>.<span class="number">6</span> Python/<span class="number">3</span>.<span class="number">11</span>.<span class="number">4</span></span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Date</span>: Mon, <span class="number">22</span> Jan <span class="number">2024</span> <span class="number">07</span>:<span class="number">08</span>:<span class="number">14</span> GMT</span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Content</span>-type: application/e-zip-compressed</span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Content</span>-Length: <span class="number">1811</span></span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Last</span>-Modified: Mon, <span class="number">22</span> Jan <span class="number">2024</span> <span class="number">07</span>:<span class="number">02</span>:<span class="number">45</span> GMT</span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"></span></span><br><span class="line"><span class="language-apache"><span class="attribute">PK</span>...</span></span><br></pre></td></tr></table></figure>

<p>client_2:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/key</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"></span><br><span class="line"><span class="language-http"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.5.72:8000</span></span><br><span class="line"><span class="language-http"></span></span><br><span class="line"><span class="language-http"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Wget/1.21.2</span></span><br><span class="line"><span class="language-http"></span></span><br><span class="line"><span class="language-http"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span></span><br><span class="line"><span class="language-http"></span></span><br><span class="line"><span class="language-http"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>identity</span></span><br><span class="line"><span class="language-http"></span></span><br><span class="line"><span class="language-http"><span class="attribute">Connection</span><span class="punctuation">: </span>Keep-Alive</span></span><br></pre></td></tr></table></figure>

<p>server_2:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.0</span> <span class="number">200</span> OK</span><br><span class="line"></span><br><span class="line"><span class="language-vbnet"><span class="symbol">Server:</span> SimpleHTTP/<span class="number">0.6</span> Python/<span class="number">3.11</span>.<span class="number">4</span></span></span><br><span class="line"><span class="language-vbnet"></span></span><br><span class="line"><span class="language-vbnet"><span class="symbol">Date:</span> Mon, <span class="number">22</span> Jan <span class="number">2024</span> <span class="number">07</span>:<span class="number">08</span>:<span class="number">16</span> GMT</span></span><br><span class="line"><span class="language-vbnet"></span></span><br><span class="line"><span class="language-vbnet">Content-type: application/octet-stream</span></span><br><span class="line"><span class="language-vbnet"></span></span><br><span class="line"><span class="language-vbnet">Content-Length: <span class="number">2008</span></span></span><br><span class="line"><span class="language-vbnet"></span></span><br><span class="line"><span class="language-vbnet">Last-Modified: Sat, <span class="number">02</span> Dec <span class="number">2023</span> <span class="number">08</span>:<span class="number">56</span>:<span class="number">01</span> GMT</span></span><br><span class="line"><span class="language-vbnet"></span></span><br><span class="line"><span class="language-vbnet"></span></span><br><span class="line"><span class="language-vbnet">Once upon a time <span class="keyword">in</span> the quaint town <span class="keyword">of</span> Serenity Falls, there lived a young computer whiz named Alee. Alee was known <span class="keyword">for</span> their eeceptional skills <span class="keyword">in</span> hacking <span class="built_in">and</span> coding, but they always used their talents <span class="keyword">for</span> good. The townspeople admired Alee<span class="comment">&#x27;s ability to uncover the truth and bring justice to those who needed it.</span></span></span><br><span class="line"><span class="language-vbnet"></span></span><br><span class="line"><span class="language-vbnet">One day, a mysterious message appeared <span class="keyword">on</span> Alee<span class="comment">&#x27;s computer screen. It was an anonymous tip about a nefarious plot to sabotage the town&#x27;s power grid. Intrigued and determined to protect Serenity Falls, Alee delved into the digital realm, tracing the origins of the message.</span></span></span><br><span class="line"><span class="language-vbnet"></span></span><br><span class="line"><span class="language-vbnet"><span class="keyword">As</span> Alee unraveled the layers <span class="keyword">of</span> the virtual puzzle, they discovered a complee network <span class="keyword">of</span> cybercriminals <span class="keyword">with</span> plans <span class="keyword">to</span> plunge the entire town <span class="keyword">into</span> darkness. The clock was ticking, <span class="built_in">and</span> Alee needed <span class="keyword">to</span> act swiftly. <span class="keyword">With</span> <span class="keyword">each</span> keystroke, they penetrated firewalls <span class="built_in">and</span> bypassed encrypted barriers, determined <span class="keyword">to</span> thwart the impending disaster.</span></span><br><span class="line"><span class="language-vbnet"></span></span><br><span class="line"><span class="language-vbnet">The trail led Alee <span class="keyword">to</span> an abandoned warehouse <span class="keyword">on</span> the outskirts <span class="keyword">of</span> town. Armed <span class="keyword">with</span> their laptop <span class="built_in">and</span> a sense <span class="keyword">of</span> purpose, Alee cautiously entered the darkened building. <span class="keyword">In</span> the heart <span class="keyword">of</span> the warehouse, they found a room filled <span class="keyword">with</span> servers <span class="built_in">and</span> a <span class="keyword">group</span> <span class="keyword">of</span> shadowy figures huddled around screens.</span></span><br><span class="line"><span class="language-vbnet"></span></span><br><span class="line"><span class="language-vbnet"><span class="keyword">With</span> a flourish <span class="keyword">of</span> keystrokes, Alee disabled the malicious code <span class="built_in">and</span> prevented the impending catastrophe. The criminals were apprehended, <span class="built_in">and</span> the town <span class="keyword">of</span> Serenity Falls was safe once more.</span></span><br><span class="line"><span class="language-vbnet"></span></span><br><span class="line"><span class="language-vbnet"><span class="keyword">As</span> the authorities arrived <span class="keyword">to</span> <span class="keyword">take</span> the criminals <span class="keyword">into</span> custody, Alee couldn<span class="comment">&#x27;t help but reflect on the importance of cybersecurity. Turning to the gathered crowd, Alee raised their voice and declared, &quot;In a world where digital threats lurk in the shadows, we must remain vigilant. Remember, the password is 7dd5c046fdb876f6351f4e04e8b43a20. Stay safe, Serenity Falls, and let&#x27;s build a secure future together.&quot;</span></span></span><br><span class="line"><span class="language-vbnet"></span></span><br><span class="line"><span class="language-vbnet"><span class="built_in">And</span> <span class="keyword">with</span> those words, Alee became a local hero, <span class="built_in">not</span> just <span class="keyword">for</span> their technical prowess, but <span class="keyword">for</span> their unwavering commitment <span class="keyword">to</span> safeguarding the digital realm <span class="built_in">and</span> the community they called home.</span></span><br><span class="line"><span class="language-vbnet"></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>注意到 password is 7dd5c046fdb876f6351f4e04e8b43a20，输入zip解压，密码错误，失去方向。认为该password为某些提示或第二次响应的短文中特殊单词的md5，尝试五位数字母密码碰撞、短文转字典碰撞，均失败</p>
</li>
<li><p>冷静想想不能陷入字谜游戏，回到”Real World”的宗旨，分析pcap中的包反映了怎样的事件：客户端向同一个服务器先GET Secret.zip，再GET key。而附件Secret.zip中就有key文件，比较两个key文件，发现大小相同，应该为同一个文件。回想起以前做过的zip文件雕刻实验，印象中依稀有不用知道密码就能破解zip加密的方法，又已知文件明文和文件密文，故搜索zip已知明文攻击，发现工具bkcrack</p>
</li>
<li><p>然而key文件使用ZipCrypto Deflate（而非Store）压缩加密，参考<a target="_blank" rel="noopener" href="https://github.com/kimci86/bkcrack/blob/master/example/tutorial.md">https://github.com/kimci86/bkcrack/blob/master/example/tutorial.md</a> ，即压缩后的key文件才算加密的明文，尽管已有全部的原始key文件数据，但试用Deflate压缩原始key文件，把压缩后的全部或部分数据作为明文使用bkcrack，均失败。</p>
<p><img src="/2024/01/28/Writeup-RealWorldCTF2024-The-truth-of-Plain/secret.png"></p>
</li>
<li><p>由于zip中还有一个ZipCrypto Store加密的Document.zip文件，想到上文查找zip已知明文攻击时搜到的一篇文章<a target="_blank" rel="noopener" href="https://m.freebuf.com/articles/network/255145.html">https://m.freebuf.com/articles/network/255145.html</a> ，若Document.zip是文件名为Document（或flag.txt）的压缩文件，则8个明文字节可知，再加上zip的固定签名504b0304，共12个明文字节，足够使用bkcrack破解，尝试并成功破解，解压得到Document.zip</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&gt; bkcrack <span class="literal">-C</span> .\Secret.zip <span class="literal">-c</span> Document.zip <span class="literal">-p</span> .\file_in_zip.txt <span class="literal">-o</span> <span class="number">30</span> <span class="literal">-x</span> <span class="number">0</span> <span class="number">504</span>b0304</span><br><span class="line">bkcrack <span class="number">1.6</span>.<span class="number">1</span> - <span class="number">2024</span><span class="literal">-01-22</span></span><br><span class="line">[<span class="number">23</span>:<span class="number">55</span>:<span class="number">46</span>] Attack on <span class="number">4194304</span> Z values at index <span class="number">37</span></span><br><span class="line">Keys: <span class="number">368</span>b7c25 d8b6163f d5c85e0b</span><br><span class="line"><span class="number">67.9</span> % (<span class="number">2849334</span> / <span class="number">4194304</span>)</span><br><span class="line">Found a solution. Stopping.</span><br><span class="line">You may resume the attack with the option: <span class="literal">--continue-attack</span> <span class="number">2849334</span></span><br><span class="line">[<span class="number">00</span>:<span class="number">36</span>:<span class="number">37</span>] Keys</span><br><span class="line"><span class="number">368</span>b7c25 d8b6163f d5c85e0b</span><br><span class="line">&gt; bkcrack <span class="literal">-C</span> Secret.zip <span class="literal">-c</span> Document.zip <span class="literal">-k</span> <span class="number">368</span>b7c25 d8b6163f d5c85e0b <span class="literal">-d</span> Document.zip</span><br><span class="line">bkcrack <span class="number">1.6</span>.<span class="number">1</span> - <span class="number">2024</span><span class="literal">-01-22</span></span><br><span class="line">[<span class="number">00</span>:<span class="number">40</span>:<span class="number">48</span>] Writing deciphered <span class="keyword">data</span> Document.zip (maybe compressed)</span><br><span class="line">Wrote deciphered <span class="keyword">data</span>.</span><br></pre></td></tr></table></figure>
</li>
<li><p>Document.zip需要密码，输入等凉了的7dd5c046fdb876f6351f4e04e8b43a20，解压成功，获得flag：</p>
<p>rwctf{58efb2e01a57e38359398ccb5ee7281707fa91a78e1704755e61e62a7e054445}</p>
<p><img src="/2024/01/28/Writeup-RealWorldCTF2024-The-truth-of-Plain/result.png"></p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/07/25/Sektor7-Evasion%20Windows%20RTOps%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/07/25/Sektor7-Evasion%20Windows%20RTOps%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">Sektor7-Evasion Windows RTOps笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-07-25 10:00:00" itemprop="dateCreated datePublished" datetime="2023-07-25T10:00:00+08:00">2023-07-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-04-15 21:45:53" itemprop="dateModified" datetime="2025-04-15T21:45:53+08:00">2025-04-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blog/" itemprop="url" rel="index"><span itemprop="name">blog</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Modern-Detection-Tech"><a href="#Modern-Detection-Tech" class="headerlink" title="Modern Detection Tech"></a>Modern Detection Tech</h2><p>endpoint protection</p>
<p>EDR: Endpoint Detection and Response</p>
<p>moniter operating system: network process, file activities…</p>
<p>inject their code into other process, hook apis, hide in system, moniter users’ activities</p>
<p>composed of 2 components: EDR service in user space, EDR driver in kernel space</p>
<p>user space: logging</p>
<p>kernel space: disk, network, kernel callbacks</p>
<p>when detect process creation, edr inject monitering dll that sets hooks on specific functions</p>
<h2 id="Evasion-Development-Rules"><a href="#Evasion-Development-Rules" class="headerlink" title="Evasion Development Rules"></a>Evasion Development Rules</h2><p>considerations: depend on prvlg, keep env offline, bypass development vs testing, perform attacks vs observable detections, decision paths?</p>
<p>candos: disable agent, disrupt comms, exploit blind spots, blend in</p>
<p>course env: AV - BitDefender, Monitoring - Sysmon</p>
<h2 id="Binary-Entropy"><a href="#Binary-Entropy" class="headerlink" title="Binary Entropy"></a>Binary Entropy</h2><p>Obfuscation &amp; Encryption vs Enrtopy</p>
<p>entropy used by epp or edr to detect</p>
<p>represent string using byte array</p>
<p>encoding</p>
<p>quickfix: cat other file behind it</p>
<h2 id="Module-Details"><a href="#Module-Details" class="headerlink" title="Module Details"></a>Module Details</h2><p>image details-property of file</p>
<p>tool: resource hacker</p>
<p>compile using rc</p>
<h2 id="Binary-Signature"><a href="#Binary-Signature" class="headerlink" title="Binary Signature"></a>Binary Signature</h2><p>digital signature, certificate</p>
<p>how to sign: certificate issued for co-signing, leaked certificate</p>
<p>generate self signed cer and sign binary: makecert -&gt; signtool</p>
<h2 id="Intro-Process-Unhooking"><a href="#Intro-Process-Unhooking" class="headerlink" title="Intro Process Unhooking"></a>Intro Process Unhooking</h2><p>trans from user mode to kernel mode: syscall</p>
<p>tool: processhacker</p>
<p>step: x64dbg-&gt;ntdll-&gt;func-&gt;not syscall-&gt;go to some address-&gt;processhacker-&gt;memory-&gt;find the type of the memory and which file use it-&gt;discover dll of bitdefender</p>
<p>check RX memory</p>
<p>if a memory is not likely to be some code, dump it to see if it’s meaningful as data</p>
<h2 id="Hooks-vs-Code-Injections"><a href="#Hooks-vs-Code-Injections" class="headerlink" title="Hooks vs Code Injections"></a>Hooks vs Code Injections</h2><p>check RX memory of notepad(inject target) to find shellcode</p>
<p>step: enable bitdefender-&gt;start injetction-&gt;some func of ntdll of implant gets hooked by bitdefender-&gt;implant and notepad get killed-&gt;the file of implant get removed</p>
<h2 id="Process-Unhooking-Classic"><a href="#Process-Unhooking-Classic" class="headerlink" title="Process Unhooking Classic"></a>Process Unhooking Classic</h2><p>map a copy of  ntdll from disk to overwrite the one which is hooked by edr in memory</p>
<h2 id="Hooks-vs-Hells-Gate"><a href="#Hooks-vs-Hells-Gate" class="headerlink" title="Hooks vs Hells Gate"></a>Hooks vs Hells Gate</h2><p>use system call directly-&gt;but system call number change with windows release-&gt;dynamically detect windows version-&gt;hells gate(find syscall number without redundent code)</p>
<p>hells gate: use only ntdll</p>
<p>hells gate step: find ImageExportDirectory-&gt;find func name using hash-&gt;get its address-&gt;find the “mov r10, rcx    mov rcx, &lt;syscall_number&gt;“-&gt;extract syscall number-&gt;use some asm to call</p>
<p>hells gate fail to pass bitdefender for it cant find the “…” pattern at the step above</p>
<h2 id="Hooks-vs-Halo-Gate"><a href="#Hooks-vs-Halo-Gate" class="headerlink" title="Hooks vs Halo Gate"></a>Hooks vs Halo Gate</h2><p>halo gate is a patch to hells gate</p>
<p>halo gate will resolve syscall number dynamically with hooks set</p>
<p>based on: not all func is hooked, syscall number increase linearly by func order</p>
<h2 id="Process-Unhooking-Peruns-Fart"><a href="#Process-Unhooking-Peruns-Fart" class="headerlink" title="Process Unhooking Peruns Fart"></a>Process Unhooking Peruns Fart</h2><p>get a fresh ntdll without touching disk to overwrite the hooked one</p>
<p>get ntdll from other memory when spawning a new process at which point hooks is not set(between suspended and resume) </p>
<p>copy clean “syscall table” into ntdll memory</p>
<h2 id="Silencing-Process-Event-Tracing"><a href="#Silencing-Process-Event-Tracing" class="headerlink" title="Silencing Process Event Tracing"></a>Silencing Process Event Tracing</h2><p>Event Tracing for Windows (ETW) : kernel level tracing facility, log kernel or app defined events to a log file</p>
<p>ETW API compoments: Controllers (start and stop event tracing session and enable providers), Providers (provide events), Consumers (consume events)</p>
<p>event tracing sessions consist of a set of buffers, which can be read realtime or into files</p>
<p>ETW does not guarantee capture all events</p>
<p>tool: logman, tracerpt</p>
<p>^+ how ETW is powerful</p>
<p>disable ETW: patch etw related func in ntdll</p>
<h2 id="Module-Stomping"><a href="#Module-Stomping" class="headerlink" title="Module Stomping"></a>Module Stomping</h2><p>replace contents of .text section with payload in a victim dll to avoid suspicious memory (used by no one and is RWX) and calling stack (originated from some unknown address) </p>
<h2 id="No-New-Thread-Payload-Execution"><a href="#No-New-Thread-Payload-Execution" class="headerlink" title="No New Thread Payload Execution"></a>No New Thread Payload Execution</h2><p>thread creation is visible on the kernel level</p>
<p>edr can detect thread creation event when hooks are removed</p>
<p>principle: hijack an existing thread</p>
<p>step: call the address of payload as a func directly</p>
<p>shortcoming: after execution, main thread may gets killed or hang in the memory, and process become a zombie</p>
<p>other method: call a win func which will take the address of payload as a callback func</p>
<h2 id="Classic-PPID-Spoofing"><a href="#Classic-PPID-Spoofing" class="headerlink" title="Classic PPID Spoofing"></a>Classic PPID Spoofing</h2><p>PPID &#x3D; Parent Process ID</p>
<p>change parent of a new process</p>
<p>edr rely on parent_child relationship -&gt; break the relation to avoid detection</p>
<p>use win’s built in functionality</p>
<p>its legitimate use: user accoutn control (UAC) </p>
<p>e.g. : a user wants to run a program with elevated privileges, the Application Infromation Service running under svchost will launch the elevated process with a spoofed parent (original caller), so that a new process is approperly attached to the original caller in the process tree</p>
<p>step: when creating a new process, specify some attribute of STARTUPINFO</p>
<h2 id="Changing-Parents-Scheduler"><a href="#Changing-Parents-Scheduler" class="headerlink" title="Changing Parents Scheduler"></a>Changing Parents Scheduler</h2><p>task scheduler</p>
<p>cmd: schetasks</p>
<p>task will be spawned by the Schedule service in the svchost</p>
<p>dont use cmdline, cuz easy to detect, should use win api interface</p>
<p>utilizing a COM interface to get to the task scheduler, and calls are made by invoking object methods</p>
<p>step: init a COM library, get task scheduler interface, create new task which is an object and has some fields and methds, set task parameters, set flags, get persistfile object, save the configuration to disk, run the task, process will get executed as child of svchost process</p>
<p>COM is basically a bunch of dlls</p>
<h2 id="Changing-Parents-Emotet-Method"><a href="#Changing-Parents-Emotet-Method" class="headerlink" title="Changing Parents Emotet Method"></a>Changing Parents Emotet Method</h2><p>Wmi</p>
<p>tool: wmic (used by one of the attacks of emotet malware family) </p>
<p>step: init COM library, set COM security levels to call wmi interface, get the initial locator to wmi, connect to the local root\cimv2 namespace and obtain pointer pSvc tp make IWbemServices calls, set security leavels for the proxy, use the IWbemServices pointer to make requests of wmi and set up to call the Win32_Process::Create method, create and store the values for in parameters, execute method</p>
<p>process will be executed as a child of WmiPrvSE of svchost</p>
<h2 id="Cmdline-Arguments-Spoofing"><a href="#Cmdline-Arguments-Spoofing" class="headerlink" title="Cmdline Arguments Spoofing"></a>Cmdline Arguments Spoofing</h2><p>step; start a new process suspended, retrieve infomation on PEB location in process, read the PEB from the target process, grab the ProcessParameters from PEB, set the actual arguments (the string should be shorter than the orginal one) , update the CommandLine length to hide arguments, resume the process</p>
<p>tool; process explorer</p>
<h2 id="Binding-Eventlog-2"><a href="#Binding-Eventlog-2" class="headerlink" title="Binding Eventlog 2"></a>Binding Eventlog 2</h2><p>EventLog is service in svchost</p>
<p>tool: Event Viewer, Local Security Policy</p>
<p>step: get function pointers, talk to Service Manager to find Eventlog process, get PID of svchost.exe that hosts EventLog service, open svchost.exe containing EventLog, get snapshot of all threads, parse the snapshot and search for threads belonging to EventLog, found the one from svchost.exe containing EventLog, search for subProcessTag assigned to EventLog, check if svchost.exe is 32_ or 64_bit (offset in TEB is different for each arch) , read subProcessTag value from TEB of svchost.exe, suspend those threads</p>
<p>to do anything about system service need high privileges	</p>
<h2 id="Blocking-EPP-Comms-Listing-Connections"><a href="#Blocking-EPP-Comms-Listing-Connections" class="headerlink" title="Blocking EPP Comms-Listing Connections"></a>Blocking EPP Comms-Listing Connections</h2><p>disrupt communicaton to stop the information being sent out by edr or av</p>
<p>figure out these tcp connections</p>
<p>tool: netstat</p>
<p>another method: </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic /namespace:\\root\StandardCIMv2 path msft_nettcpconnection get Localaddress,localport,remoteaddress,remoteport,owningprocess</span><br></pre></td></tr></table></figure>

<p>but want to avoid any command line tool</p>
<p>do the same thing using win api</p>
<p>step: init COM library, set COM security levels, get init locator to WMI, connect to the local root\cimv2 namespace and obtain pointer pSvc to make IWbemServices calls, set security levels to the proxy, class to target: MSFT_NetTCPConnection, create an Enumerator object to list of instance of MSFT_NetTCPConnection, get the related  values of connections</p>
<p>need local admin privileges to block those connnections </p>
<h2 id="Blocking-EPP-Comms-Firewall"><a href="#Blocking-EPP-Comms-Firewall" class="headerlink" title="Blocking EPP Comms-Firewall"></a>Blocking EPP Comms-Firewall</h2><p>tool: Windows Defender Firewall with Advanced Security</p>
<p>target outbound rules</p>
<p>create a rule to block bitdefender process specifiacally</p>
<p>step: init COM library, load NetFwPolicy2 COM, retrieve FW rules, create a new Firewall Rule object, set new FW rule to block bitdefender program (or to block all the related remote address) , add the Firewall Rule</p>
<h2 id="Blocking-EPP-Comms-Routing-Table"><a href="#Blocking-EPP-Comms-Routing-Table" class="headerlink" title="Blocking EPP Comms-Routing Table"></a>Blocking EPP Comms-Routing Table</h2><p>check routing table</p>
<p>tool: route</p>
<p>another method:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic path Win32_ip4routetable get</span><br></pre></td></tr></table></figure>

<p>or full command:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic /namespace:\\root\cimv2 path Win32_ip4routetable get</span><br></pre></td></tr></table></figure>

<p>use iphlpapi library this time</p>
<p>step: vars used for GetIpForwardTable, allocate some space on a heap for routing table, get contents of routing table and resize if buffer too small, retrieve routing table</p>
<h2 id="Blocking-EPP-Comms-Routing"><a href="#Blocking-EPP-Comms-Routing" class="headerlink" title="Blocking EPP Comms-Routing"></a>Blocking EPP Comms-Routing</h2><p>change routing table</p>
<p>step: create a ipforward row, set destination address and mask, set next_hop to some bogus address, set interface index (1 &#x3D;&#x3D; loopback) and proto, create a ip forward entry</p>
<p>need admin privileges</p>
<p>careful: may cut off c2 channel if some dns is blocked</p>
<h2 id="Dancing-with-Sysmon-Detection"><a href="#Dancing-with-Sysmon-Detection" class="headerlink" title="Dancing with Sysmon-Detection"></a>Dancing with Sysmon-Detection</h2><p>how to see if the sysmon is runing</p>
<p>powershell: </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-Process</span> | <span class="built_in">Where-Object</span> &#123; <span class="variable">$_</span>.ProcessName <span class="operator">-eq</span> <span class="string">&quot;Sysmon&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-CimInstance</span> win32_service <span class="literal">-Filter</span> <span class="string">&quot;Description = &#x27;System Monitor service&#x27;&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-Process</span> | <span class="built_in">Where-Object</span> &#123; <span class="variable">$_</span>.DisplayName <span class="operator">-like</span> <span class="string">&quot;sys*&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg query <span class="string">&quot;HKCU\Software\Sysinternals\System Monitor&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg query <span class="string">&quot;HKCU\Software\Sysinternals&quot;</span></span><br></pre></td></tr></table></figure>

<p>cmd:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logman query provider | findstr /i sysm</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logman query providers | findstr /i sys</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fltmc</span><br></pre></td></tr></table></figure>

<p>fltmc - altitude of sysmon can be changed</p>
<p>-&gt; query reg:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\WINEVT\Channels\Microsoft<span class="literal">-Windows-Sysmon</span>/Operational</span><br></pre></td></tr></table></figure>

<p>may get a OwningPublsher guid {xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx}</p>
<p>-&gt; query reg:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\WINEVT\Publishers\&#123;xxxxxxxx<span class="literal">-xxxx-xxxx-xxxx-xxxxxxxxxxxx</span>&#125;\ChannelReferences</span><br></pre></td></tr></table></figure>

<p>get name</p>
<p>-&gt; use logman:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logman query providers &#123;xxxxxxxx<span class="literal">-xxxx-xxxx-xxxx-xxxxxxxxxxxx</span>&#125;</span><br></pre></td></tr></table></figure>

<p>-&gt; get a PID -&gt; tasklist</p>
<p>just know the service name, the name of the driver is still unknown</p>
<p>-&gt; query reg:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg query <span class="string">&quot;HKLM\SYSTEM\CurrentControlSet\Services\xxxx\Parameters&quot;</span></span><br></pre></td></tr></table></figure>

<p>get subkey - drivername</p>
<p>if high privilege gained, use directly:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fltmc instances</span><br></pre></td></tr></table></figure>

<p>use winapi:</p>
<p>step: get WINEVT channels key, search for Sysmon guid, get provider name, get all processes registered to the provider</p>
<p>step (with high privileges): enumerate all minifilters, print relevant information</p>
<h2 id="Dancing-with-Sysmon-Killem"><a href="#Dancing-with-Sysmon-Killem" class="headerlink" title="Dancing with Sysmon-Killem"></a>Dancing with Sysmon-Killem</h2><p>admin privileges:</p>
<p>sysmon is not hardened against local admin</p>
<p>config can be changed easily</p>
<p>get info about it:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg query <span class="string">&quot;HKLM\SYSTEM\CurrentControlSet\Services\drivername\Parameters&quot;</span></span><br></pre></td></tr></table></figure>

<p>unload driver of sysmon to remove the kernel part of it:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fltmc unload</span><br></pre></td></tr></table></figure>

<p>step: SetPrivilege(SE_LOAD_DRIVER_NAME, ENABLE), FilterUnload(L”xxxx”)</p>
<p>but some error is logged (Event Viewer)</p>
<p>kill the sysmon</p>
<p>change the altitude of minifilter (driver) of sysmon into some altitude that has been occupied:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg query <span class="string">&quot;HKLM\SYSTEM\CurrentControlSet\Services\drivername\Instances\Sysmon Instance&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg add <span class="string">&quot;HKLM\SYSTEM\CurrentControlSet\Services\drivername\Instances\Sysmon Instance&quot;</span> /v Altitude /t REG<span class="literal">-SZ</span> /d <span class="number">320832</span> /f</span><br></pre></td></tr></table></figure>

<p>reboot</p>
<p>error log: failed to access the driver</p>
<h2 id="Dancing-with-Sysmon-Silent-Gag"><a href="#Dancing-with-Sysmon-Silent-Gag" class="headerlink" title="Dancing with Sysmon-Silent Gag"></a>Dancing with Sysmon-Silent Gag</h2><p>nothing will be logged</p>
<p>step: open target process (sysmon) , get address of EtwEventWrite in ntdll and patch it</p>
<h2 id="Evasion-Decision-Tree"><a href="#Evasion-Decision-Tree" class="headerlink" title="Evasion Decision Tree"></a>Evasion Decision Tree</h2><table>
<thead>
<tr>
<th>Pre-execution</th>
</tr>
</thead>
<tbody><tr>
<td>Obfuscatoin</td>
</tr>
<tr>
<td>Encryption</td>
</tr>
<tr>
<td>Entropy</td>
</tr>
<tr>
<td>Image Details</td>
</tr>
<tr>
<td>Binary Signature</td>
</tr>
<tr>
<td>Sandbox Evasion</td>
</tr>
</tbody></table>
<p>if we touch the disk, principle: make it like normal binary</p>
<table>
<thead>
<tr>
<th>Post-execution</th>
</tr>
</thead>
<tbody><tr>
<td><u>Process clean-up:</u></td>
</tr>
<tr>
<td>Hooks removal</td>
</tr>
<tr>
<td>Native API</td>
</tr>
<tr>
<td>Patching ETW</td>
</tr>
<tr>
<td>Patching AMSI</td>
</tr>
<tr>
<td>Unloading AV&#x2F;EDR DLL</td>
</tr>
</tbody></table>
<p>regardless of the privileges</p>
<p>if running with high privs:</p>
<table>
<thead>
<tr>
<th>Post-execution</th>
</tr>
</thead>
<tbody><tr>
<td><u>High Privs?</u></td>
</tr>
<tr>
<td>EPP communications disruption</td>
</tr>
<tr>
<td>Disabling Eventlog</td>
</tr>
<tr>
<td>Disabling ETW</td>
</tr>
<tr>
<td>Disabling AV&#x2F;EDR</td>
</tr>
<tr>
<td>AV&#x2F;EDR unload</td>
</tr>
<tr>
<td>AV&#x2F;EDR uninstall</td>
</tr>
</tbody></table>
<p>if running without local admin privs:</p>
<table>
<thead>
<tr>
<th>Post execution</th>
</tr>
</thead>
<tbody><tr>
<td><u>Low Privs?</u></td>
</tr>
<tr>
<td>Bypassig detection rules</td>
</tr>
<tr>
<td>Module stomping</td>
</tr>
<tr>
<td>Executing code w&#x2F;o new thread</td>
</tr>
<tr>
<td>PPID spoofing</td>
</tr>
<tr>
<td>Cmdline args spoofing</td>
</tr>
<tr>
<td>Remote process clean-up before injection</td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/21/%E5%A0%86%E6%94%BB%E5%87%BB%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/21/%E5%A0%86%E6%94%BB%E5%87%BB%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">堆攻击笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-10-21 10:00:00" itemprop="dateCreated datePublished" datetime="2022-10-21T10:00:00+08:00">2022-10-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-04-15 21:57:10" itemprop="dateModified" datetime="2025-04-15T21:57:10+08:00">2025-04-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blog/" itemprop="url" rel="index"><span itemprop="name">blog</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="堆分配"><a href="#堆分配" class="headerlink" title="堆分配"></a>堆分配</h2><p>堆是动态分配的内存，程序可以按需请求和释放</p>
<p>堆是全局的内存，程序中的任何部分都可以访问和修改它</p>
<p>堆内存在程序内存中的位置：</p>
<p><img src="/2022/10/21/%E5%A0%86%E6%94%BB%E5%87%BB%E7%AC%94%E8%AE%B0/linuxFlexibleAddressSpaceLayout.png"></p>
<p><code>stdlib.h</code>提供标准库函数用于访问、修改和管理动态内存，常用的函数是 <code>malloc</code>和 <code>free</code></p>
<p><a href="#malloc">malloc和free函数</a></p>
<p>这些标准库提供的函数基于操作系统之上，用于高效地管理堆内存</p>
<p><code>malloc</code>使用系统调用 <code>brk</code>和 <code>mmap</code>来获取内存</p>
<p><code>brk</code>通过增加 program break (brk) 从内核获取内存（非零初始化）</p>
<p>最初，堆段的开始（start_break）和结束（brk）指向同一位置</p>
<p><code>mmap</code>用于创建私有匿名映射段，私有匿名映射的主要目的是分配新的内存（零填充），这个新的内存将由调用进程专门使用</p>
<h2 id="Chunk"><a href="#Chunk" class="headerlink" title="Chunk"></a>Chunk</h2><p>堆块</p>
<p>分配的堆块：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    chunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">            |             Size of previous chunk, <span class="keyword">if</span> <span class="title function_">unallocated</span> <span class="params">(P clear)</span>  |</span><br><span class="line">            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">            |             Size of chunk, in bytes                     |A|M|P|</span><br><span class="line">      mem-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">            |             User data starts here...                          .</span><br><span class="line">            .                                                               .</span><br><span class="line">            .             <span class="params">(malloc_usable_size() bytes)</span>                      .</span><br><span class="line">            .                                                               |</span><br><span class="line">nextchunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">            |             <span class="params">(size of chunk, but used <span class="keyword">for</span> application data)</span>    |</span><br><span class="line">            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">            |             Size of next chunk, in bytes                |A|0|1|</span><br><span class="line">            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure>

<p>空闲的堆块：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    chunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">            |             Size of previous chunk, <span class="keyword">if</span> <span class="title function_">unallocated</span> <span class="params">(P clear)</span>  |</span><br><span class="line">            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">    `head:&#x27; |             Size of chunk, in bytes                     |A|0|P|</span><br><span class="line">      mem-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">            |             Forward pointer to next chunk in <span class="built_in">list</span>             |</span><br><span class="line">            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">            |             Back pointer to previous chunk in <span class="built_in">list</span>            |</span><br><span class="line">            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">            |             Unused <span class="title function_">space</span> <span class="params">(may be <span class="number">0</span> bytes <span class="type">long</span>)</span>                .</span><br><span class="line">            .                                                               .</span><br><span class="line">            .                                                               |</span><br><span class="line">nextchunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">    `foot:&#x27; |             Size of chunk, in bytes                           |</span><br><span class="line">            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">            |             Size of next chunk, in bytes                |A|0|0|</span><br><span class="line">            +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure>

<p>由于堆块都是alignment（通常为8或16字节）对齐的，所以表示堆块大小的size的最低3bit可用于标志位</p>
<p><strong>P (PREV_INUSE)</strong>: 0 当前一个堆块 (不是链表中的前一个，是内存相邻的前一个) 空闲时 (因此前一个堆块的大小被存储在第一项). </p>
<p>The very first chunk allocated has this bit set. If it is 1, then we cannot determine the size of the previous chunk.</p>
<p><strong>M (IS_MMAPPED)</strong>: 堆块通过 <code>mmap</code>获得的. 其他两个标志位可以忽略.</p>
<p> <code>mmapped</code> chunks are neither in an arena, not adjacent to a free chunk.</p>
<p><strong>A (NON_MAIN_ARENA)</strong>: 0 for chunks in the main arena. Each thread spawned receives its own arena and for those chunks, this bit is set.</p>
<p>空闲堆块处于一个循环双链表中</p>
<p>在fastbin中的堆块被当作已分配的堆块，因为它们没有与邻近的空闲块合并</p>
<p><a href="#malloc_chunk">堆块的数据结构</a></p>
<h2 id="Arena"><a href="#Arena" class="headerlink" title="Arena"></a>Arena</h2><p>Arena是堆的内部数据结构，包括控制信息、bins和特殊堆块等</p>
<p><code>malloc_state</code>表示一个arena头部的细节</p>
<p><a href="#malloc_state">malloc_state数据结构</a></p>
<p>主线程的arena是一个全局变量，并不是堆段的一部分；其他线程的arena头本身存储在堆段中</p>
<p>非主线程的arena可以有多个相关的堆（这里的堆指的是用到的内部结构而非堆段）</p>
<h2 id="Bin"><a href="#Bin" class="headerlink" title="Bin"></a>Bin</h2><p>一个bin是一个由空闲堆块组成的链表（单向或双向）</p>
<p>根据它们包含的堆块大小区分bin：</p>
<ol>
<li><p>Fast bin</p>
</li>
<li><p>Unsorted bin</p>
</li>
<li><p>Small bin</p>
</li>
<li><p>Large bin</p>
</li>
</ol>
<p>维持fastbin<strong>s</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> *<span class="title">mfastbinptr</span>;</span></span><br><span class="line"></span><br><span class="line">mfastbinptr fastbinsY[]; <span class="comment">// Array of pointers to chunks</span></span><br></pre></td></tr></table></figure>

<p>用一个数组维持unsorted, small和large bin<strong>s</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">mchunkptr</span>;</span></span><br><span class="line"></span><br><span class="line">mchunkptr bins[]; <span class="comment">// Array of pointers to chunks</span></span><br></pre></td></tr></table></figure>

<p>最初，初始化时small和large bins是空的</p>
<p>每个bin由bins数组中的两个值表示，第一个是指向bin链表头部的指针，第二个是指向bin链表尾部的指针。对于fastbins（bin是单向链表），第二个值是NULL</p>
<h3 id="fast-bins"><a href="#fast-bins" class="headerlink" title="fast bins"></a>fast bins</h3><p>有10个fast bin，每个bin维持一个单向链表，插入和删除操作发生在链表前部（front）（LIFO方式）</p>
<p>每个bin的堆块大小相同，分别是：16, 24, 32, 40, 48, 56, 64, 72, 80, 88字节（包括控制信息）</p>
<p>两个内存连续的空闲快堆块不会聚合</p>
<h3 id="unsorted-bin"><a href="#unsorted-bin" class="headerlink" title="unsorted bin"></a>unsorted bin</h3><p>只有1个unsorted bin</p>
<p>释放时，小型和大型堆块进入这个bin</p>
<p>这个bin的主要目的是作为一个缓存层，加速分配和释放请求</p>
<h3 id="small-bins"><a href="#small-bins" class="headerlink" title="small bins"></a>small bins</h3><p>有62个small bin</p>
<p>small bins比large bins快，慢于fastbins</p>
<p>每个bin维持一个双向链表，头插入，尾删除（FIFO方式）</p>
<p>每个bin的堆块大小相同，分别是：16, 24, …, 504字节（spacing为8）</p>
<p>释放时，小堆块在进入unsorted bin之前可能聚合</p>
<h3 id="large-bins"><a href="#large-bins" class="headerlink" title="large bins"></a>large bins</h3><p>有63个large bin</p>
<p>每个bin维持一个双向链表</p>
<p>一个特殊的bin有不同大小的堆块，降序排列（最大的堆块在头部，最小的在尾部），可在任意位置插入和删除</p>
<p>spacing阶梯式增加</p>
<p>释放时，大堆块在进入unsorted bin之前可能聚合</p>
<p>spacing总结：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">No. of Bins       Spacing between bins</span><br><span class="line"></span><br><span class="line">64 bins of size       8  [ Small bins]</span><br><span class="line">32 bins of size      64  [ Large bins]</span><br><span class="line">16 bins of size     512  [ Large bins]</span><br><span class="line">8 bins of size     4096  [ ..        ]</span><br><span class="line">4 bins of size    32768</span><br><span class="line">2 bins of size   262144</span><br><span class="line">1 bin  of size what&#x27;s left</span><br></pre></td></tr></table></figure>

<h3 id="特殊堆块"><a href="#特殊堆块" class="headerlink" title="特殊堆块"></a>特殊堆块</h3><h4 id="top-chunk"><a href="#top-chunk" class="headerlink" title="top chunk"></a>top chunk</h4><p>这个堆块和arena的顶部相邻</p>
<p>服务于 <code>malloc</code>请求时，top chunk是最后的选择</p>
<p>如果还需要更多的大小，它能通过系统调用 <code>sbrk</code>增长</p>
<p>它的<code>PREV_INUSE</code>标志位为1</p>
<h4 id="last-remainder-chunk"><a href="#last-remainder-chunk" class="headerlink" title="last remainder chunk"></a>last remainder chunk</h4><p>是从最后一次分离堆块获得的</p>
<p>当请求的内存大小没有一个正好的堆块能匹配时，更大的堆块就会被一分为二，一部分返回给用户，另一部分变为last remainder chunk</p>
<h2 id="内存分配器"><a href="#内存分配器" class="headerlink" title="内存分配器"></a>内存分配器</h2><ul>
<li>dlmalloc – General purpose allocator</li>
<li><strong>ptmalloc2 – glibc</strong></li>
<li>jemalloc – FreeBSD and Firefox</li>
<li>tcmalloc – Google</li>
<li>libumem – Solaris</li>
</ul>
<h2 id="ptmalloc堆管理"><a href="#ptmalloc堆管理" class="headerlink" title="ptmalloc堆管理"></a>ptmalloc堆管理</h2><h3 id="空闲chunk管理"><a href="#空闲chunk管理" class="headerlink" title="空闲chunk管理"></a>空闲chunk管理</h3><p>分箱式：</p>
<p>首先，它会根据空闲的 chunk 的<strong>大小</strong>以及<strong>使用状态</strong>将 chunk 初步分为 4 类：fast bins，small bins，large bins，unsorted bin。每类中仍然有更细的划分，相似大小的 chunk 会用双向链表链接起来。也就是说，在每类 bin 的内部仍然会有多个互不相关的链表来保存不同大小的 chunk。</p>
<p>对于 small bins，large bins，unsorted bin 来说，ptmalloc 将它们维护在同一个数组中。这些 bin 对应的数据结构在 malloc_state 中，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> NBINS 128</span></span><br><span class="line"><span class="comment">/* Normal bins packed as described above */</span></span><br><span class="line">mchunkptr bins[ NBINS * <span class="number">2</span> - <span class="number">2</span> ];</span><br></pre></td></tr></table></figure>

<p>数组中的 bin 依次如下</p>
<ol>
<li>第一个为 unsorted bin，字如其面，这里面的 chunk 没有进行排序，存储的 chunk 比较杂。</li>
<li>索引从 2 到 63 的 bin 称为 small bin，同一个 small bin 链表中的 chunk 的大小相同。两个相邻索引的 small bin 链表中的 chunk 大小相差的字节数为 <strong>2 个机器字长</strong>，即 32 位相差 8 字节，64 位相差 16 字节。</li>
<li>small bins 后面的 bin 被称作 large bins。large bins 中的每一个 bin 都包含一定范围内的 chunk，其中的 chunk 按 fd 指针的顺序从大到小排列。相同大小的 chunk 同样按照最近使用顺序排列。</li>
</ol>
<p>此外，上述这些 bin 的排布都会遵循一个原则：<strong>任意两个物理相邻的空闲 chunk 不能在一起</strong>。</p>
<p>需要注意的是，并不是所有的 chunk 被释放后就立即被放到 bin 中。ptmalloc 为了提高分配的速度，会把一些小的 chunk <strong>先</strong>放到 fast bins 的容器内。<strong>而且，fastbin 容器中的 chunk 的使用标记总是被置位的，所以不满足上面的原则。</strong></p>
<h2 id="数据结构和函数"><a href="#数据结构和函数" class="headerlink" title="数据结构和函数"></a>数据结构和函数</h2><h3 id="INTERNAL-SIZE-T"><a href="#INTERNAL-SIZE-T" class="headerlink" title="INTERNAL_SIZE_T"></a><code>INTERNAL_SIZE_T</code></h3><p>默认等同于 <code>size_t</code>，32位下为4字节，64位下为8字节</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* INTERNAL_SIZE_T is the word-size used for internal bookkeeping of</span></span><br><span class="line"><span class="comment">   chunk sizes.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   The default version is the same as size_t.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   While not strictly necessary, it is best to define this as an</span></span><br><span class="line"><span class="comment">   unsigned type, even if size_t is a signed type. This may avoid some</span></span><br><span class="line"><span class="comment">   artificial size limitations on some systems.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   On a 64-bit machine, you may be able to reduce malloc overhead by</span></span><br><span class="line"><span class="comment">   defining INTERNAL_SIZE_T to be a 32 bit `unsigned int&#x27; at the</span></span><br><span class="line"><span class="comment">   expense of not being able to handle more than 2^32 of malloced</span></span><br><span class="line"><span class="comment">   space. If this limitation is acceptable, you are encouraged to set</span></span><br><span class="line"><span class="comment">   this unless you are on a platform requiring 16byte alignments. In</span></span><br><span class="line"><span class="comment">   this case the alignment requirements turn out to negate any</span></span><br><span class="line"><span class="comment">   potential advantages of decreasing size_t word size.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   Implementors: Beware of the possible combinations of:</span></span><br><span class="line"><span class="comment">     - INTERNAL_SIZE_T might be signed or unsigned, might be 32 or 64 bits,</span></span><br><span class="line"><span class="comment">       and might be the same width as int or as long</span></span><br><span class="line"><span class="comment">     - size_t might have different width and signedness as INTERNAL_SIZE_T</span></span><br><span class="line"><span class="comment">     - int and long might be 32 or 64 bits, and might be the same width</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   To deal with this, most comparisons and difference computations</span></span><br><span class="line"><span class="comment">   among INTERNAL_SIZE_Ts should cast them to unsigned long, being</span></span><br><span class="line"><span class="comment">   aware of the fact that casting an unsigned int to a wider long does</span></span><br><span class="line"><span class="comment">   not sign-extend. (This also makes checking for negative numbers</span></span><br><span class="line"><span class="comment">   awkward.) Some of these casts result in harmless compiler warnings</span></span><br><span class="line"><span class="comment">   on some systems.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> INTERNAL_SIZE_T</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> INTERNAL_SIZE_T size_t</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h3 id="Alignment"><a href="#Alignment" class="headerlink" title="Alignment"></a><code>Alignment</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Alignment = <span class="number">2</span> * (<span class="keyword">sizeof</span>(<span class="type">size_t</span>))</span><br></pre></td></tr></table></figure>

<h3 id="MORECORE"><a href="#MORECORE" class="headerlink" title="MORECORE"></a><code>MORECORE</code></h3><p>获取更多内存的路径，默认为 <code>sbrk</code></p>
<h3 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a><code>malloc</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  malloc(size_t n)</span></span><br><span class="line"><span class="comment">  Returns a pointer to a newly allocated chunk of at least n</span></span><br><span class="line"><span class="comment">  bytes, or null if no space is available. Additionally, on </span></span><br><span class="line"><span class="comment">  failure, errno is set to ENOMEM on ANSI C systems.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  If n is zero, malloc returns a minimum-sized chunk. (The</span></span><br><span class="line"><span class="comment">  minimum size is 16 bytes on most 32bit systems, and 24 or 32</span></span><br><span class="line"><span class="comment">  bytes on 64bit systems.)  On most systems, size_t is an unsigned</span></span><br><span class="line"><span class="comment">  type, so calls with negative arguments are interpreted as</span></span><br><span class="line"><span class="comment">  requests for huge amounts of space, which will often fail. The</span></span><br><span class="line"><span class="comment">  maximum supported value of n differs across systems, but is in</span></span><br><span class="line"><span class="comment">  all cases less than the maximum representable value of a</span></span><br><span class="line"><span class="comment">  size_t.</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="free"><a href="#free" class="headerlink" title="free"></a><code>free</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  free(void* p)</span></span><br><span class="line"><span class="comment">  Releases the chunk of memory pointed to by p, that had been</span></span><br><span class="line"><span class="comment">  previously allocated using malloc or a related routine such as</span></span><br><span class="line"><span class="comment">  realloc. It has no effect if p is null. It can have arbitrary</span></span><br><span class="line"><span class="comment">  (i.e., bad!) effects if p has already been freed.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  Unless disabled (using mallopt), freeing very large spaces will</span></span><br><span class="line"><span class="comment">  when possible, automatically trigger operations that give</span></span><br><span class="line"><span class="comment">  back unused memory to the system, thus reducing program</span></span><br><span class="line"><span class="comment">  footprint.</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h3 id="heap-info"><a href="#heap-info" class="headerlink" title="heap_info"></a><code>heap_info</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">heap_info</span> &#123;</span></span><br><span class="line">	mstate ar_ptr; <span class="comment">/* Arena for this heap. */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">heap_info</span> * <span class="title">prev</span>;</span> <span class="comment">/* Previous heap. */</span></span><br><span class="line">	<span class="type">size_t</span> size; <span class="comment">/* Current size in bytes. */</span></span><br><span class="line">	<span class="type">char</span> pad[<span class="number">-5</span> * SIZE_SZ &amp; MALLOC_ALIGN_MASK];</span><br><span class="line">&#125; heap_info; </span><br></pre></td></tr></table></figure>

<p><code>mstate ar_ptr</code>  a pointer to the heaps arena, this implies a one-to-one relationship between heaps and arenas (jf: dc) </p>
<p><code>struct _heap_info *ptr</code> a pointer to the previous heap_info structure, the heap_info structures are maintained in a circular singular linked list (jf: dc) </p>
<p><code>struct _heap_info *ptr</code> a pointer to the previous heap_info structure, the heap_info structures are maintained in a circular singular linked list (jf: dc) </p>
<p><code>size_t size</code> size of the current heap </p>
<p><code>char pad[…]</code> used for padding to ensure proper alignment </p>
<h3 id="malloc-state"><a href="#malloc-state" class="headerlink" title="malloc_state"></a><code>malloc_state</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/* Serialize access.  */</span></span><br><span class="line">  __libc_lock_define (, mutex);</span><br><span class="line">  <span class="comment">/* Flags (formerly in max_fast).  */</span></span><br><span class="line">  <span class="type">int</span> flags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Fastbins */</span></span><br><span class="line">  mfastbinptr fastbinsY[NFASTBINS];</span><br><span class="line">  <span class="comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span></span><br><span class="line">  mchunkptr top;</span><br><span class="line">  <span class="comment">/* The remainder from the most recent split of a small request */</span></span><br><span class="line">  mchunkptr last_remainder;</span><br><span class="line">  <span class="comment">/* Normal bins packed as described above */</span></span><br><span class="line">  mchunkptr bins[NBINS * <span class="number">2</span> - <span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Bitmap of bins */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> binmap[BINMAPSIZE];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Linked list */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next</span>;</span></span><br><span class="line">  <span class="comment">/* Linked list for free arenas.  Access to this field is serialized</span></span><br><span class="line"><span class="comment">     by free_list_lock in arena.c.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next_free</span>;</span></span><br><span class="line">  <span class="comment">/* Number of threads attached to this arena.  0 if the arena is on</span></span><br><span class="line"><span class="comment">     the free list.  Access to this field is serialized by</span></span><br><span class="line"><span class="comment">     free_list_lock in arena.c.  */</span></span><br><span class="line"></span><br><span class="line">  INTERNAL_SIZE_T attached_threads;</span><br><span class="line">  <span class="comment">/* Memory allocated from the system in this arena.  */</span></span><br><span class="line">  INTERNAL_SIZE_T system_mem;</span><br><span class="line">  INTERNAL_SIZE_T max_system_mem;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">mstate</span>;</span></span><br></pre></td></tr></table></figure>

<h3 id="malloc-chunk"><a href="#malloc-chunk" class="headerlink" title="malloc_chunk"></a><code>malloc_chunk</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line">  INTERNAL_SIZE_T      mchunk_prev_size;  <span class="comment">/* Size of previous chunk, if it is free. */</span></span><br><span class="line">  INTERNAL_SIZE_T      mchunk_size;       <span class="comment">/* Size in bytes, including overhead. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>                <span class="comment">/* double links -- used only if this chunk is free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></span><br><span class="line">  <span class="comment">/* Only used for large blocks: pointer to next larger size.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span> <span class="comment">/* double links -- used only if this chunk is free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">mchunkptr</span>;</span></span><br></pre></td></tr></table></figure>

<h3 id="arena-get-ar-ptr-size"><a href="#arena-get-ar-ptr-size" class="headerlink" title="arena_get(ar_ptr, size)"></a><code>arena_get(ar_ptr, size)</code></h3><p>获得一个arena并锁住相应的mutex</p>
<p><code>ar_ptr</code>指向arena</p>
<p><code>size</code>只是一个马上需要多少内存的提示</p>
<h3 id="sysmalloc"><a href="#sysmalloc" class="headerlink" title="sysmalloc"></a><code>sysmalloc</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   sysmalloc handles malloc cases requiring more memory from the system.</span></span><br><span class="line"><span class="comment">   On entry, it is assumed that av-&gt;top does not have enough</span></span><br><span class="line"><span class="comment">   space to service request for nb bytes, thus requiring that av-&gt;top</span></span><br><span class="line"><span class="comment">   be extended or replaced.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<h3 id="void-alloc-perturb-char-p-size-t-n"><a href="#void-alloc-perturb-char-p-size-t-n" class="headerlink" title="void alloc_perturb (char *p, size_t n)"></a><code>void alloc_perturb (char *p, size_t n)</code></h3><p>If <code>perturb_byte</code> (tunable parameter for malloc using <code>M_PERTURB</code>) is non-zero (by default it is 0), sets the <code>n</code> bytes pointed to by <code>p</code> to be equal to <code>perturb_byte</code> ^ 0xff.</p>
<h3 id="void-free-perturb-char-p-size-t-n"><a href="#void-free-perturb-char-p-size-t-n" class="headerlink" title="void free_perturb (char *p, size_t n)"></a><code>void free_perturb (char *p, size_t n)</code></h3><p>If <code>perturb_byte</code> (tunable parameter for malloc using <code>M_PERTURB</code>) is non-zero (by default it is 0), sets the <code>n</code> bytes pointed to by <code>p</code> to be equal to <code>perturb_byte</code>.</p>
<h3 id="void-malloc-init-state-mstate-av"><a href="#void-malloc-init-state-mstate-av" class="headerlink" title="void malloc_init_state (mstate av)"></a><code>void malloc_init_state (mstate av)</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   Initialize a malloc_state struct.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   This is called only from within malloc_consolidate, which needs</span></span><br><span class="line"><span class="comment">   be called in the same contexts anyway.  It is never called directly</span></span><br><span class="line"><span class="comment">   outside of malloc_consolidate because some optimizing compilers try</span></span><br><span class="line"><span class="comment">   to inline it at all call points, which turns out not to be an</span></span><br><span class="line"><span class="comment">   optimization at all. (Inlining it in malloc_consolidate is fine though.)</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<ol>
<li><p>非fast bins，为每一个bin创建空的循环双向链表</p>
</li>
<li><p>把<code>av</code>的<code>FASTCHUNKS_BIT</code>置位</p>
</li>
<li><p>初始化 <code>av-&gt;top</code> 为第一个unsorted chunk</p>
</li>
</ol>
<h3 id="unlink-AV-P-BK-FD"><a href="#unlink-AV-P-BK-FD" class="headerlink" title="unlink(AV, P, BK, FD)"></a><code>unlink(AV, P, BK, FD)</code></h3><p>定义的宏，把一个堆块从一个bin中移除</p>
<ol>
<li><p>检查这个堆块的 <code>size</code> 和下一个堆块（内存相邻）中的 <code>prev_size</code>相同，否则报错error (“corrupted size vs. prev_size”)</p>
</li>
<li><p>检查 <code>P-&gt;fd-&gt;bk == P</code> and <code>P-&gt;bk-&gt;fd == P</code>，否则报错error (“corrupted double-linked list”)</p>
</li>
<li><p>调整链表中前后堆块的指针以实现移除：</p>
<ol>
<li>Set <code>P-&gt;fd-&gt;bk</code> &#x3D; <code>P-&gt;bk</code>.</li>
<li>Set <code>P-&gt;bk-&gt;fd</code> &#x3D; <code>P-&gt;fd</code>.</li>
</ol>
</li>
</ol>
<h3 id="void-malloc-consolidate-mstate-av"><a href="#void-malloc-consolidate-mstate-av" class="headerlink" title="void malloc_consolidate(mstate av)"></a><code>void malloc_consolidate(mstate av)</code></h3><p>这是free()的特别版本</p>
<ol>
<li><p>检查 <code>global_max_fast</code> 是否为0 (<code>av</code> 未初始化) ，如果为0，用 <code>av</code> 为参数调用 <code>malloc_init_state</code> 并返回</p>
</li>
<li><p>如果 <code>global_max_fast</code> 非零，把 <code>av</code> 的<code>FASTCHUNKS_BIT</code>清零</p>
</li>
<li><p>在fastbin数组上从头到尾迭代：</p>
<ol>
<li><p>获得一个当前fastbin堆块的锁，若非NULL则继续处理</p>
</li>
<li><p>如果前一个堆块(内存相邻) 空闲，对其调用<code>unlink</code> </p>
</li>
<li><p>如果下一个堆块(内存相邻) 不是top chunk：</p>
<ol>
<li>如果下一个堆块空闲，对其调用 <code>unlink</code> </li>
<li>将堆块和前一个、后一个空闲堆块合并，然后将聚合的堆块插入unsorted bin的头部</li>
</ol>
</li>
<li><p>如果下一个堆块(内存相邻) 是一个top chunk，适当地合并为一个top chunk</p>
</li>
</ol>
</li>
</ol>
<p><em>注意</em>：对是否“空闲”的定义是检查<code>PREV_IN_USE</code> 标志位，因此这里其他fastbin堆块不会被认为是空闲的</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">6</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
